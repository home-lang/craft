<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Craft Bridge Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }
    h1 { font-size: 24px; margin-bottom: 20px; text-align: center; }
    h2 { font-size: 18px; margin: 20px 0 10px; color: #888; }
    .section { margin-bottom: 30px; }
    .btn {
      display: inline-block;
      background: #4a4a8a;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn:active { background: #5a5a9a; }
    .btn.success { background: #2a7a3a; }
    .btn.error { background: #7a2a2a; }
    .result {
      background: #2a2a4e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    .status.ready { background: #2a7a3a; }
    .status.waiting { background: #7a5a2a; }
    .status.error { background: #7a2a2a; }
    #log {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #000;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 11px;
      z-index: 100;
    }
  </style>
</head>
<body>
  <h1>Craft Bridge Test <span id="status" class="status waiting">Waiting...</span></h1>
  <div id="platform"></div>

  <!-- Debug Mode -->
  <div class="section">
    <h2>Debug Mode</h2>
    <button class="btn" onclick="toggleDebugMode()">Toggle Debug</button>
    <button class="btn" onclick="showLastError()">Last Error</button>
    <button class="btn" onclick="showCallLog()">Call Log</button>
    <button class="btn" onclick="clearCallLog()">Clear Log</button>
    <button class="btn" onclick="showErrorHistory()">Error History</button>
    <button class="btn" onclick="showConsoleLog()">Console Log</button>
    <button class="btn" onclick="showNetworkLog()">Network Log</button>
    <button class="btn" onclick="showDebugReport()">Full Report</button>
    <div id="debug-result" class="result">Debug mode: OFF</div>
  </div>

  <!-- Core -->
  <div class="section">
    <h2>Core</h2>
    <button class="btn" onclick="testHaptic()">Test Haptics</button>
    <button class="btn" onclick="testShare()">Test Share</button>
    <button class="btn" onclick="testLog()">Test Log</button>
    <button class="btn" onclick="testDeviceInfo()">Device Info</button>
    <div id="core-result" class="result">Results will appear here...</div>
  </div>

  <!-- Camera & Media -->
  <div class="section">
    <h2>Camera & Media</h2>
    <button class="btn" onclick="testCamera()">Open Camera</button>
    <button class="btn" onclick="testGallery()">Pick Image</button>
    <button class="btn" onclick="testQRScanner()">Scan QR Code</button>
    <button class="btn" onclick="testScreenshot()">Screenshot</button>
    <div id="camera-result" class="result">Results will appear here...</div>
  </div>

  <!-- Audio/Video Recording -->
  <div class="section">
    <h2>Audio/Video Recording</h2>
    <button class="btn" onclick="testStartAudio()">Start Audio</button>
    <button class="btn" onclick="testStopAudio()">Stop Audio</button>
    <button class="btn" onclick="testVideoRecording()">Record Video</button>
    <div id="recording-result" class="result">Results will appear here...</div>
  </div>

  <!-- Files -->
  <div class="section">
    <h2>Files</h2>
    <button class="btn" onclick="testFilePicker()">Pick File</button>
    <button class="btn" onclick="testDownloadFile()">Download File</button>
    <div id="files-result" class="result">Results will appear here...</div>
  </div>

  <!-- Location & Sensors -->
  <div class="section">
    <h2>Location & Sensors</h2>
    <button class="btn" onclick="testLocation()">Get Location</button>
    <button class="btn" onclick="testStartMotion()">Start Motion</button>
    <button class="btn" onclick="testStopMotion()">Stop Motion</button>
    <div id="sensors-result" class="result">Results will appear here...</div>
  </div>

  <!-- Contacts -->
  <div class="section">
    <h2>Contacts</h2>
    <button class="btn" onclick="testGetContacts()">Get Contacts</button>
    <button class="btn" onclick="testAddContact()">Add Contact</button>
    <div id="contacts-result" class="result">Results will appear here...</div>
  </div>

  <!-- Calendar -->
  <div class="section">
    <h2>Calendar</h2>
    <button class="btn" onclick="testGetCalendarEvents()">Get Events</button>
    <button class="btn" onclick="testCreateCalendarEvent()">Create Event</button>
    <div id="calendar-result" class="result">Results will appear here...</div>
  </div>

  <!-- Local Notifications -->
  <div class="section">
    <h2>Local Notifications</h2>
    <button class="btn" onclick="testScheduleNotification()">Schedule (5s)</button>
    <button class="btn" onclick="testCancelNotification()">Cancel</button>
    <button class="btn" onclick="testGetPendingNotifications()">Get Pending</button>
    <div id="notifications-result" class="result">Results will appear here...</div>
  </div>

  <!-- In-App Purchase -->
  <div class="section">
    <h2>In-App Purchase</h2>
    <button class="btn" onclick="testGetProducts()">Get Products</button>
    <button class="btn" onclick="testRestorePurchases()">Restore Purchases</button>
    <div id="iap-result" class="result">Results will appear here...</div>
  </div>

  <!-- Screen Control -->
  <div class="section">
    <h2>Screen Control</h2>
    <button class="btn" onclick="testKeepAwakeOn()">Keep Awake ON</button>
    <button class="btn" onclick="testKeepAwakeOff()">Keep Awake OFF</button>
    <button class="btn" onclick="testLockPortrait()">Lock Portrait</button>
    <button class="btn" onclick="testLockLandscape()">Lock Landscape</button>
    <button class="btn" onclick="testUnlockOrientation()">Unlock</button>
    <div id="screen-result" class="result">Results will appear here...</div>
  </div>

  <!-- Connectivity -->
  <div class="section">
    <h2>Connectivity</h2>
    <button class="btn" onclick="testNetwork()">Network Status</button>
    <button class="btn" onclick="testStartBluetooth()">Start BLE Scan</button>
    <button class="btn" onclick="testStopBluetooth()">Stop BLE Scan</button>
    <button class="btn" onclick="testNFC()">Scan NFC</button>
    <div id="connectivity-result" class="result">Results will appear here...</div>
  </div>

  <!-- Database -->
  <div class="section">
    <h2>Local Database (SQLite)</h2>
    <button class="btn" onclick="testDBCreate()">Create Table</button>
    <button class="btn" onclick="testDBInsert()">Insert Data</button>
    <button class="btn" onclick="testDBQuery()">Query Data</button>
    <div id="db-result" class="result">Results will appear here...</div>
  </div>

  <!-- Auth & Security -->
  <div class="section">
    <h2>Auth & Security</h2>
    <button class="btn" onclick="testBiometric()">Biometric Auth</button>
    <button class="btn" onclick="testAppleSignIn()">Apple Sign In</button>
    <button class="btn" onclick="testSecureStore()">Secure Storage</button>
    <div id="auth-result" class="result">Results will appear here...</div>
  </div>

  <!-- Clipboard -->
  <div class="section">
    <h2>Clipboard</h2>
    <button class="btn" onclick="testClipboardWrite()">Write Clipboard</button>
    <button class="btn" onclick="testClipboardRead()">Read Clipboard</button>
    <div id="clipboard-result" class="result">Results will appear here...</div>
  </div>

  <!-- System -->
  <div class="section">
    <h2>System</h2>
    <button class="btn" onclick="testFlashlight()">Toggle Flashlight</button>
    <button class="btn" onclick="testVibrate()">Vibrate Pattern</button>
    <button class="btn" onclick="testOpenURL()">Open URL</button>
    <button class="btn" onclick="testAppState()">App State</button>
    <button class="btn" onclick="testBadge()">Set Badge</button>
    <button class="btn" onclick="testReview()">Request Review</button>
    <div id="system-result" class="result">Results will appear here...</div>
  </div>

  <!-- Speech -->
  <div class="section">
    <h2>Speech Recognition</h2>
    <button class="btn" onclick="testStartListening()">Start Listening</button>
    <button class="btn" onclick="testStopListening()">Stop Listening</button>
    <div id="speech-result" class="result">Results will appear here...</div>
  </div>

  <!-- Medium Value Bridges -->
  <div class="section">
    <h2>Background Tasks</h2>
    <button class="btn" onclick="testRegisterBgTask()">Register Task</button>
    <button class="btn" onclick="testScheduleBgTask()">Schedule Task</button>
    <button class="btn" onclick="testCancelBgTask()">Cancel Task</button>
    <button class="btn" onclick="testCancelAllBgTasks()">Cancel All</button>
    <div id="bgtask-result" class="result">Results will appear here...</div>
  </div>

  <div class="section">
    <h2>PDF Viewer</h2>
    <button class="btn" onclick="testOpenPDFUrl()">Open PDF (URL)</button>
    <button class="btn" onclick="testClosePDF()">Close PDF</button>
    <div id="pdf-result" class="result">Results will appear here...</div>
  </div>

  <div class="section">
    <h2>Contacts Picker</h2>
    <button class="btn" onclick="testPickContact()">Pick Contact</button>
    <button class="btn" onclick="testPickMultipleContacts()">Pick Multiple</button>
    <div id="pickcontact-result" class="result">Results will appear here...</div>
  </div>

  <div class="section">
    <h2>App Shortcuts</h2>
    <button class="btn" onclick="testSetShortcuts()">Set Shortcuts</button>
    <button class="btn" onclick="testClearShortcuts()">Clear Shortcuts</button>
    <div id="shortcuts-result" class="result">Results will appear here...</div>
  </div>

  <div class="section">
    <h2>Shared Keychain</h2>
    <button class="btn" onclick="testSetSharedItem()">Set Item</button>
    <button class="btn" onclick="testGetSharedItem()">Get Item</button>
    <button class="btn" onclick="testRemoveSharedItem()">Remove Item</button>
    <div id="keychain-result" class="result">Results will appear here...</div>
  </div>

  <div class="section">
    <h2>Auth Persistence</h2>
    <button class="btn" onclick="testEnableAuthPersistence()">Enable (5 min)</button>
    <button class="btn" onclick="testCheckAuthPersistence()">Check Status</button>
    <button class="btn" onclick="testClearAuthPersistence()">Clear</button>
    <div id="authpersist-result" class="result">Results will appear here...</div>
  </div>

  <!-- Nice to Have Bridges -->
  <div class="section">
    <h2>AR (ARKit/ARCore)</h2>
    <button class="btn" onclick="testStartAR()">Start AR</button>
    <button class="btn" onclick="testPlaceARObject()">Place Box</button>
    <button class="btn" onclick="testGetARPlanes()">Get Planes</button>
    <button class="btn" onclick="testStopAR()">Stop AR</button>
    <div id="ar-result" class="result">Results will appear here...</div>
  </div>

  <div class="section">
    <h2>ML (Vision/ML Kit)</h2>
    <button class="btn" onclick="testCaptureAndClassify()">Capture & Classify</button>
    <button class="btn" onclick="testCaptureAndDetect()">Capture & Detect</button>
    <button class="btn" onclick="testCaptureAndOCR()">Capture & OCR</button>
    <div id="ml-result" class="result">Results will appear here...</div>
  </div>

  <!-- Widgets -->
  <div class="section">
    <h2>Widgets (WidgetKit/AppWidgetProvider)</h2>
    <button class="btn" onclick="testUpdateWidget()">Update Widget</button>
    <button class="btn" onclick="testReloadWidgets()">Reload Widgets</button>
    <div id="widget-result" class="result">Results will appear here...</div>
  </div>

  <!-- Voice Assistant -->
  <div class="section">
    <h2>Siri / Google Assistant</h2>
    <button class="btn" onclick="testRegisterSiri()">Register Shortcut</button>
    <button class="btn" onclick="testRemoveSiri()">Remove Shortcut</button>
    <div id="siri-result" class="result">Results will appear here...</div>
  </div>

  <!-- Watch Connectivity -->
  <div class="section">
    <h2>Watch Connectivity</h2>
    <button class="btn" onclick="testWatchReachable()">Check Reachable</button>
    <button class="btn" onclick="testSendToWatch()">Send Message</button>
    <button class="btn" onclick="testUpdateWatchContext()">Update Context</button>
    <div id="watch-result" class="result">Results will appear here...</div>
  </div>

  <!-- Deep Links -->
  <div class="section">
    <h2>Deep Links</h2>
    <button class="btn" onclick="testGetInitialURL()">Get Initial URL</button>
    <button class="btn" onclick="setupDeepLinkListener()">Setup Listener</button>
    <div id="deeplink-result" class="result">Results will appear here...</div>
  </div>

  <!-- Performance Profiling -->
  <div class="section">
    <h2>Performance Profiling</h2>
    <button class="btn" onclick="testStartProfiling()">Start Profiling</button>
    <button class="btn" onclick="testStopProfiling()">Stop Profiling</button>
    <button class="btn" onclick="testGetProfilingData()">Get Data</button>
    <button class="btn" onclick="testGetMemoryUsage()">Memory Usage</button>
    <div id="profiling-result" class="result">Results will appear here...</div>
  </div>

  <!-- OTA Updates -->
  <div class="section">
    <h2>OTA Updates</h2>
    <button class="btn" onclick="testOTAConfigure()">Configure</button>
    <button class="btn" onclick="testCheckForUpdate()">Check Update</button>
    <button class="btn" onclick="testDownloadUpdate()">Download</button>
    <button class="btn" onclick="testGetCurrentBundle()">Current Bundle</button>
    <div id="ota-result" class="result">Results will appear here...</div>
  </div>

  <div id="log"></div>

  <script>
    // Logging utility
    function log(msg) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${time}] ${msg}\n` + logEl.innerHTML;
      console.log(msg);
    }

    function showResult(id, data) {
      document.getElementById(id).textContent = typeof data === 'object'
        ? JSON.stringify(data, null, 2)
        : String(data);
    }

    // Wait for Craft
    window.addEventListener('craftReady', (e) => {
      document.getElementById('status').textContent = 'Ready';
      document.getElementById('status').className = 'status ready';
      document.getElementById('platform').textContent = `Platform: ${e.detail.platform}`;
      log('Craft ready! Platform: ' + e.detail.platform);
      log('Capabilities: ' + JSON.stringify(e.detail.capabilities));
    });

    // Speech events
    window.addEventListener('craftSpeechStart', () => {
      log('Speech started');
      showResult('speech-result', 'Listening...');
    });
    window.addEventListener('craftSpeechResult', (e) => {
      log('Speech result: ' + e.detail.transcript);
      showResult('speech-result', `Transcript: ${e.detail.transcript}\nFinal: ${e.detail.isFinal}`);
    });
    window.addEventListener('craftSpeechEnd', () => {
      log('Speech ended');
    });
    window.addEventListener('craftSpeechError', (e) => {
      log('Speech error: ' + e.detail.error);
      showResult('speech-result', 'Error: ' + e.detail.error);
    });

    // Motion events
    window.addEventListener('craftMotionUpdate', (e) => {
      showResult('sensors-result', {
        accelerometer: e.detail.accelerometer,
        gyroscope: e.detail.gyroscope
      });
    });

    // Bluetooth events
    window.addEventListener('craftBluetoothDevice', (e) => {
      log('BLE device: ' + e.detail.name);
      const current = document.getElementById('connectivity-result').textContent;
      showResult('connectivity-result', current + '\nDevice: ' + JSON.stringify(e.detail));
    });

    // Debug mode error events
    window.addEventListener('craftError', (e) => {
      log('Craft error: ' + e.detail.code + ' - ' + e.detail.message);
      showResult('debug-result', 'Error: ' + JSON.stringify(e.detail, null, 2));
    });

    // Debug mode functions
    var debugModeOn = false;
    function toggleDebugMode() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      debugModeOn = !debugModeOn;
      window.craft.setDebugMode(debugModeOn);
      showResult('debug-result', 'Debug mode: ' + (debugModeOn ? 'ON' : 'OFF'));
      log('Debug mode ' + (debugModeOn ? 'enabled' : 'disabled'));
    }

    function showLastError() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      const error = window.craft.getLastError();
      showResult('debug-result', error ? JSON.stringify(error, null, 2) : 'No errors recorded');
    }

    function showCallLog() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      const callLog = window.craft.getCallLog();
      showResult('debug-result', callLog.length > 0
        ? 'Call log (' + callLog.length + ' entries):\n' + JSON.stringify(callLog.slice(-10), null, 2)
        : 'No calls logged (enable debug mode first)');
    }

    function clearCallLog() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      window.craft.clearCallLog();
      showResult('debug-result', 'Call log cleared');
      log('Call log cleared');
    }

    function showErrorHistory() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      const history = window.craft.getErrorHistory ? window.craft.getErrorHistory() : [];
      showResult('debug-result', history.length > 0
        ? 'Error history (' + history.length + ' errors):\n' + JSON.stringify(history.slice(-5), null, 2)
        : 'No errors recorded');
    }

    function showConsoleLog() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      const consoleLogs = window.craft.getConsoleLog ? window.craft.getConsoleLog() : [];
      showResult('debug-result', consoleLogs.length > 0
        ? 'Console log (' + consoleLogs.length + ' entries):\n' + JSON.stringify(consoleLogs.slice(-10), null, 2)
        : 'No console logs captured (enable debug mode first)');
    }

    function showNetworkLog() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      const networkLogs = window.craft.getNetworkLog ? window.craft.getNetworkLog() : [];
      showResult('debug-result', networkLogs.length > 0
        ? 'Network log (' + networkLogs.length + ' requests):\n' + JSON.stringify(networkLogs.slice(-10), null, 2)
        : 'No network requests captured (enable debug mode first)');
    }

    function showDebugReport() {
      if (!window.craft) return showResult('debug-result', 'Craft not ready');
      const report = window.craft.getDebugReport ? window.craft.getDebugReport() : null;
      if (report) {
        showResult('debug-result', 'Debug Report:\n' + JSON.stringify(report, null, 2));
      } else {
        showResult('debug-result', 'Debug report not available');
      }
    }

    // Core tests
    function testHaptic() {
      if (!window.craft) return showResult('core-result', 'Craft not ready');
      window.craft.haptic('success');
      window.craft.haptic('light');
      window.craft.haptic('selection');
      showResult('core-result', 'Haptic feedback triggered (success, light, selection)');
    }

    function testShare() {
      if (!window.craft) return showResult('core-result', 'Craft not ready');
      window.craft.share('Testing Craft bridges!', 'Craft Test');
      showResult('core-result', 'Share sheet opened');
    }

    function testLog() {
      if (!window.craft) return showResult('core-result', 'Craft not ready');
      window.craft.log('Test log message from JavaScript');
      showResult('core-result', 'Log message sent to native console');
    }

    function testDeviceInfo() {
      if (!window.craft) return showResult('core-result', 'Craft not ready');
      const info = window.craft.getDeviceInfo();
      showResult('core-result', info);
    }

    // Camera tests
    async function testCamera() {
      if (!window.craft) return showResult('camera-result', 'Craft not ready');
      try {
        const image = await window.craft.openCamera();
        showResult('camera-result', 'Image captured! Base64 length: ' + (image?.length || 0));
      } catch (e) {
        showResult('camera-result', 'Error: ' + e.message);
      }
    }

    async function testGallery() {
      if (!window.craft) return showResult('camera-result', 'Craft not ready');
      try {
        const image = await window.craft.pickImage();
        showResult('camera-result', 'Image selected! Base64 length: ' + (image?.length || 0));
      } catch (e) {
        showResult('camera-result', 'Error: ' + e.message);
      }
    }

    async function testQRScanner() {
      if (!window.craft) return showResult('camera-result', 'Craft not ready');
      try {
        const code = await window.craft.scanQRCode();
        showResult('camera-result', 'Scanned: ' + code);
      } catch (e) {
        showResult('camera-result', 'Error: ' + e.message);
      }
    }

    async function testScreenshot() {
      if (!window.craft) return showResult('camera-result', 'Craft not ready');
      try {
        const screenshot = await window.craft.takeScreenshot();
        showResult('camera-result', 'Screenshot captured! Base64 length: ' + (screenshot?.length || 0));
      } catch (e) {
        showResult('camera-result', 'Error: ' + e.message);
      }
    }

    // Audio/Video tests
    async function testStartAudio() {
      if (!window.craft) return showResult('recording-result', 'Craft not ready');
      try {
        await window.craft.startAudioRecording();
        showResult('recording-result', 'Audio recording started...');
      } catch (e) {
        showResult('recording-result', 'Error: ' + e.message);
      }
    }

    async function testStopAudio() {
      if (!window.craft) return showResult('recording-result', 'Craft not ready');
      try {
        const audio = await window.craft.stopAudioRecording();
        showResult('recording-result', 'Audio recorded! Base64 length: ' + (audio?.length || 0));
      } catch (e) {
        showResult('recording-result', 'Error: ' + e.message);
      }
    }

    async function testVideoRecording() {
      if (!window.craft) return showResult('recording-result', 'Craft not ready');
      try {
        const video = await window.craft.startVideoRecording();
        showResult('recording-result', 'Video recorded! Base64 length: ' + (video?.length || 0));
      } catch (e) {
        showResult('recording-result', 'Error: ' + e.message);
      }
    }

    // File tests
    async function testFilePicker() {
      if (!window.craft) return showResult('files-result', 'Craft not ready');
      try {
        const file = await window.craft.pickFile();
        showResult('files-result', {
          name: file?.name,
          dataLength: file?.data?.length || 0
        });
      } catch (e) {
        showResult('files-result', 'Error: ' + e.message);
      }
    }

    async function testDownloadFile() {
      if (!window.craft) return showResult('files-result', 'Craft not ready');
      try {
        await window.craft.downloadFile('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', 'test.pdf');
        showResult('files-result', 'File download started');
      } catch (e) {
        showResult('files-result', 'Error: ' + e.message);
      }
    }

    // Location & Sensors tests
    async function testLocation() {
      if (!window.craft) return showResult('sensors-result', 'Craft not ready');
      try {
        const pos = await window.craft.getCurrentPosition();
        showResult('sensors-result', pos);
      } catch (e) {
        showResult('sensors-result', 'Error: ' + e.message);
      }
    }

    function testStartMotion() {
      if (!window.craft) return showResult('sensors-result', 'Craft not ready');
      window.craft.startMotionUpdates();
      showResult('sensors-result', 'Motion updates started (watch for updates)...');
    }

    function testStopMotion() {
      if (!window.craft) return showResult('sensors-result', 'Craft not ready');
      window.craft.stopMotionUpdates();
      showResult('sensors-result', 'Motion updates stopped');
    }

    // Connectivity tests
    function testNetwork() {
      if (!window.craft) return showResult('connectivity-result', 'Craft not ready');
      const status = window.craft.getNetworkStatus();
      showResult('connectivity-result', status);
    }

    function testStartBluetooth() {
      if (!window.craft) return showResult('connectivity-result', 'Craft not ready');
      window.craft.startBluetoothScan();
      showResult('connectivity-result', 'Bluetooth scan started...');
    }

    function testStopBluetooth() {
      if (!window.craft) return showResult('connectivity-result', 'Craft not ready');
      window.craft.stopBluetoothScan();
      showResult('connectivity-result', 'Bluetooth scan stopped');
    }

    async function testNFC() {
      if (!window.craft) return showResult('connectivity-result', 'Craft not ready');
      try {
        const data = await window.craft.scanNFC();
        showResult('connectivity-result', 'NFC data: ' + data);
      } catch (e) {
        showResult('connectivity-result', 'Error: ' + e.message);
      }
    }

    // Database tests
    async function testDBCreate() {
      if (!window.craft?.db) return showResult('db-result', 'Craft DB not ready');
      try {
        await window.craft.db.execute('CREATE TABLE IF NOT EXISTS test_users (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, created_at TEXT)');
        showResult('db-result', 'Table created successfully');
      } catch (e) {
        showResult('db-result', 'Error: ' + e.message);
      }
    }

    async function testDBInsert() {
      if (!window.craft?.db) return showResult('db-result', 'Craft DB not ready');
      try {
        const now = new Date().toISOString();
        await window.craft.db.execute('INSERT INTO test_users (name, created_at) VALUES (?, ?)', ['Test User ' + Date.now(), now]);
        showResult('db-result', 'Data inserted successfully');
      } catch (e) {
        showResult('db-result', 'Error: ' + e.message);
      }
    }

    async function testDBQuery() {
      if (!window.craft?.db) return showResult('db-result', 'Craft DB not ready');
      try {
        const results = await window.craft.db.query('SELECT * FROM test_users ORDER BY id DESC LIMIT 5');
        showResult('db-result', results);
      } catch (e) {
        showResult('db-result', 'Error: ' + e.message);
      }
    }

    // Auth tests
    async function testBiometric() {
      if (!window.craft) return showResult('auth-result', 'Craft not ready');
      try {
        const result = await window.craft.authenticate('Confirm your identity');
        showResult('auth-result', 'Authenticated: ' + result);
      } catch (e) {
        showResult('auth-result', 'Error: ' + e.message);
      }
    }

    async function testAppleSignIn() {
      if (!window.craft) return showResult('auth-result', 'Craft not ready');
      try {
        const user = await window.craft.signInWithApple();
        showResult('auth-result', user);
      } catch (e) {
        showResult('auth-result', 'Error: ' + e.message);
      }
    }

    async function testSecureStore() {
      if (!window.craft?.secureStore) return showResult('auth-result', 'Craft secureStore not ready');
      try {
        await window.craft.secureStore.set('test_key', 'test_value_' + Date.now());
        const value = await window.craft.secureStore.get('test_key');
        showResult('auth-result', 'Stored and retrieved: ' + value);
      } catch (e) {
        showResult('auth-result', 'Error: ' + e.message);
      }
    }

    // Clipboard tests
    async function testClipboardWrite() {
      if (!window.craft?.clipboard) return showResult('clipboard-result', 'Craft clipboard not ready');
      try {
        await window.craft.clipboard.write('Hello from Craft! ' + Date.now());
        showResult('clipboard-result', 'Text written to clipboard');
      } catch (e) {
        showResult('clipboard-result', 'Error: ' + e.message);
      }
    }

    async function testClipboardRead() {
      if (!window.craft?.clipboard) return showResult('clipboard-result', 'Craft clipboard not ready');
      try {
        const text = await window.craft.clipboard.read();
        showResult('clipboard-result', 'Clipboard: ' + text);
      } catch (e) {
        showResult('clipboard-result', 'Error: ' + e.message);
      }
    }

    // System tests
    function testFlashlight() {
      if (!window.craft) return showResult('system-result', 'Craft not ready');
      window.craft.toggleFlashlight();
      showResult('system-result', 'Flashlight toggled');
    }

    function testVibrate() {
      if (!window.craft) return showResult('system-result', 'Craft not ready');
      window.craft.vibrate([100, 50, 100, 50, 200]);
      showResult('system-result', 'Vibration pattern triggered');
    }

    function testOpenURL() {
      if (!window.craft) return showResult('system-result', 'Craft not ready');
      window.craft.openURL('https://github.com');
      showResult('system-result', 'Opening URL in browser...');
    }

    function testAppState() {
      if (!window.craft) return showResult('system-result', 'Craft not ready');
      const state = window.craft.getAppState();
      showResult('system-result', 'App state: ' + state);
    }

    function testBadge() {
      if (!window.craft) return showResult('system-result', 'Craft not ready');
      window.craft.setBadge(5);
      setTimeout(() => window.craft.clearBadge(), 3000);
      showResult('system-result', 'Badge set to 5 (will clear in 3s)');
    }

    async function testReview() {
      if (!window.craft) return showResult('system-result', 'Craft not ready');
      try {
        await window.craft.requestReview();
        showResult('system-result', 'Review requested');
      } catch (e) {
        showResult('system-result', 'Error: ' + e.message);
      }
    }

    // Speech tests
    function testStartListening() {
      if (!window.craft) return showResult('speech-result', 'Craft not ready');
      window.craft.startListening();
      showResult('speech-result', 'Started listening...');
    }

    function testStopListening() {
      if (!window.craft) return showResult('speech-result', 'Craft not ready');
      window.craft.stopListening();
      showResult('speech-result', 'Stopped listening');
    }

    // ==================== High Value Bridges Tests ====================

    // Contacts tests
    async function testGetContacts() {
      if (!window.craft) return showResult('contacts-result', 'Craft not ready');
      try {
        const contacts = await window.craft.getContacts();
        showResult('contacts-result', 'Found ' + (contacts?.length || 0) + ' contacts:\n' + JSON.stringify(contacts?.slice(0, 5), null, 2));
      } catch (e) {
        showResult('contacts-result', 'Error: ' + e.message);
      }
    }

    async function testAddContact() {
      if (!window.craft) return showResult('contacts-result', 'Craft not ready');
      try {
        const id = await window.craft.addContact({
          givenName: 'Test',
          familyName: 'User',
          displayName: 'Test User',
          phone: '+1234567890',
          email: 'test@example.com'
        });
        showResult('contacts-result', 'Contact created with ID: ' + id);
      } catch (e) {
        showResult('contacts-result', 'Error: ' + e.message);
      }
    }

    // Calendar tests
    async function testGetCalendarEvents() {
      if (!window.craft) return showResult('calendar-result', 'Craft not ready');
      try {
        const now = Date.now();
        const events = await window.craft.getCalendarEvents(now, now + 30 * 24 * 60 * 60 * 1000);
        showResult('calendar-result', 'Found ' + (events?.length || 0) + ' events:\n' + JSON.stringify(events?.slice(0, 5), null, 2));
      } catch (e) {
        showResult('calendar-result', 'Error: ' + e.message);
      }
    }

    async function testCreateCalendarEvent() {
      if (!window.craft) return showResult('calendar-result', 'Craft not ready');
      try {
        const now = Date.now();
        const id = await window.craft.createCalendarEvent({
          title: 'Test Event from Craft',
          location: 'Test Location',
          notes: 'Created by Craft bridge test',
          startDate: now + 3600000,
          endDate: now + 7200000,
          isAllDay: false
        });
        showResult('calendar-result', 'Event created with ID: ' + id);
      } catch (e) {
        showResult('calendar-result', 'Error: ' + e.message);
      }
    }

    // Local Notifications tests
    let lastNotificationId = null;
    async function testScheduleNotification() {
      if (!window.craft) return showResult('notifications-result', 'Craft not ready');
      try {
        lastNotificationId = await window.craft.scheduleNotification({
          id: 'test-' + Date.now(),
          title: 'Test Notification',
          body: 'This is a test notification from Craft!',
          badge: 1,
          delay: 5000 // 5 seconds
        });
        showResult('notifications-result', 'Notification scheduled with ID: ' + lastNotificationId + '\n(Will appear in 5 seconds)');
      } catch (e) {
        showResult('notifications-result', 'Error: ' + e.message);
      }
    }

    async function testCancelNotification() {
      if (!window.craft) return showResult('notifications-result', 'Craft not ready');
      if (!lastNotificationId) return showResult('notifications-result', 'No notification to cancel');
      try {
        await window.craft.cancelNotification(lastNotificationId);
        showResult('notifications-result', 'Notification cancelled: ' + lastNotificationId);
      } catch (e) {
        showResult('notifications-result', 'Error: ' + e.message);
      }
    }

    async function testGetPendingNotifications() {
      if (!window.craft) return showResult('notifications-result', 'Craft not ready');
      try {
        const pending = await window.craft.getPendingNotifications();
        showResult('notifications-result', 'Pending notifications: ' + JSON.stringify(pending, null, 2));
      } catch (e) {
        showResult('notifications-result', 'Error: ' + e.message);
      }
    }

    // IAP tests
    async function testGetProducts() {
      if (!window.craft) return showResult('iap-result', 'Craft not ready');
      try {
        const products = await window.craft.getProducts(['premium', 'coins_100']);
        showResult('iap-result', 'Products: ' + JSON.stringify(products, null, 2));
      } catch (e) {
        showResult('iap-result', 'Error: ' + e.message);
      }
    }

    async function testRestorePurchases() {
      if (!window.craft) return showResult('iap-result', 'Craft not ready');
      try {
        await window.craft.restorePurchases();
        showResult('iap-result', 'Restore purchases initiated');
      } catch (e) {
        showResult('iap-result', 'Error: ' + e.message);
      }
    }

    // Screen control tests
    function testKeepAwakeOn() {
      if (!window.craft) return showResult('screen-result', 'Craft not ready');
      window.craft.setKeepAwake(true);
      showResult('screen-result', 'Keep awake: ON (screen will not dim)');
    }

    function testKeepAwakeOff() {
      if (!window.craft) return showResult('screen-result', 'Craft not ready');
      window.craft.setKeepAwake(false);
      showResult('screen-result', 'Keep awake: OFF (screen will dim normally)');
    }

    function testLockPortrait() {
      if (!window.craft) return showResult('screen-result', 'Craft not ready');
      window.craft.lockOrientation('portrait');
      showResult('screen-result', 'Orientation locked: PORTRAIT');
    }

    function testLockLandscape() {
      if (!window.craft) return showResult('screen-result', 'Craft not ready');
      window.craft.lockOrientation('landscape');
      showResult('screen-result', 'Orientation locked: LANDSCAPE');
    }

    function testUnlockOrientation() {
      if (!window.craft) return showResult('screen-result', 'Craft not ready');
      window.craft.unlockOrientation();
      showResult('screen-result', 'Orientation unlocked: ALL');
    }

    // ==================== Medium Value Bridges Tests ====================

    // Background Tasks tests
    async function testRegisterBgTask() {
      if (!window.craft?.backgroundTask) return showResult('bgtask-result', 'backgroundTask not available');
      try {
        const result = await window.craft.backgroundTask.register('craft-sync');
        showResult('bgtask-result', 'Registered: ' + JSON.stringify(result));
      } catch (e) {
        showResult('bgtask-result', 'Error: ' + e.message);
      }
    }

    async function testScheduleBgTask() {
      if (!window.craft?.backgroundTask) return showResult('bgtask-result', 'backgroundTask not available');
      try {
        const result = await window.craft.backgroundTask.schedule('craft-sync', {
          delay: 900,
          requiresNetwork: true,
          requiresCharging: false
        });
        showResult('bgtask-result', 'Scheduled: ' + JSON.stringify(result));
      } catch (e) {
        showResult('bgtask-result', 'Error: ' + e.message);
      }
    }

    async function testCancelBgTask() {
      if (!window.craft?.backgroundTask) return showResult('bgtask-result', 'backgroundTask not available');
      try {
        const result = await window.craft.backgroundTask.cancel('craft-sync');
        showResult('bgtask-result', 'Cancelled: ' + JSON.stringify(result));
      } catch (e) {
        showResult('bgtask-result', 'Error: ' + e.message);
      }
    }

    async function testCancelAllBgTasks() {
      if (!window.craft?.backgroundTask) return showResult('bgtask-result', 'backgroundTask not available');
      try {
        const result = await window.craft.backgroundTask.cancelAll();
        showResult('bgtask-result', 'Cancelled all: ' + JSON.stringify(result));
      } catch (e) {
        showResult('bgtask-result', 'Error: ' + e.message);
      }
    }

    // PDF Viewer tests
    async function testOpenPDFUrl() {
      if (!window.craft) return showResult('pdf-result', 'Craft not ready');
      try {
        const result = await window.craft.openPDF('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf');
        showResult('pdf-result', 'PDF opened: ' + JSON.stringify(result));
      } catch (e) {
        showResult('pdf-result', 'Error: ' + e.message);
      }
    }

    async function testClosePDF() {
      if (!window.craft) return showResult('pdf-result', 'Craft not ready');
      try {
        const result = await window.craft.closePDF();
        showResult('pdf-result', 'PDF closed: ' + result);
      } catch (e) {
        showResult('pdf-result', 'Error: ' + e.message);
      }
    }

    // Contacts Picker tests
    async function testPickContact() {
      if (!window.craft) return showResult('pickcontact-result', 'Craft not ready');
      try {
        const contact = await window.craft.pickContact();
        showResult('pickcontact-result', 'Selected: ' + JSON.stringify(contact, null, 2));
      } catch (e) {
        showResult('pickcontact-result', 'Error: ' + e.message);
      }
    }

    async function testPickMultipleContacts() {
      if (!window.craft) return showResult('pickcontact-result', 'Craft not ready');
      try {
        const contacts = await window.craft.pickContact({multiple: true});
        showResult('pickcontact-result', 'Selected ' + (contacts?.length || 0) + ' contacts:\n' + JSON.stringify(contacts, null, 2));
      } catch (e) {
        showResult('pickcontact-result', 'Error: ' + e.message);
      }
    }

    // App Shortcuts tests
    async function testSetShortcuts() {
      if (!window.craft?.shortcuts) return showResult('shortcuts-result', 'shortcuts not available');
      try {
        const result = await window.craft.shortcuts.set([
          {type: 'new-message', title: 'New Message', subtitle: 'Start composing', iconName: 'square.and.pencil'},
          {type: 'search', title: 'Search', iconName: 'magnifyingglass'},
          {type: 'settings', title: 'Settings', iconName: 'gear'}
        ]);
        showResult('shortcuts-result', 'Shortcuts set: ' + JSON.stringify(result));
      } catch (e) {
        showResult('shortcuts-result', 'Error: ' + e.message);
      }
    }

    async function testClearShortcuts() {
      if (!window.craft?.shortcuts) return showResult('shortcuts-result', 'shortcuts not available');
      try {
        const result = await window.craft.shortcuts.clear();
        showResult('shortcuts-result', 'Shortcuts cleared: ' + result);
      } catch (e) {
        showResult('shortcuts-result', 'Error: ' + e.message);
      }
    }

    // Listen for shortcut events
    window.addEventListener('craftShortcut', (e) => {
      log('Shortcut activated: ' + e.detail.type);
      showResult('shortcuts-result', 'Shortcut activated: ' + JSON.stringify(e.detail));
    });

    // Shared Keychain tests
    async function testSetSharedItem() {
      if (!window.craft?.sharedKeychain) return showResult('keychain-result', 'sharedKeychain not available');
      try {
        const result = await window.craft.sharedKeychain.set('test_key', 'test_value_' + Date.now());
        showResult('keychain-result', 'Set: ' + JSON.stringify(result));
      } catch (e) {
        showResult('keychain-result', 'Error: ' + e.message);
      }
    }

    async function testGetSharedItem() {
      if (!window.craft?.sharedKeychain) return showResult('keychain-result', 'sharedKeychain not available');
      try {
        const result = await window.craft.sharedKeychain.get('test_key');
        showResult('keychain-result', 'Get: ' + JSON.stringify(result));
      } catch (e) {
        showResult('keychain-result', 'Error: ' + e.message);
      }
    }

    async function testRemoveSharedItem() {
      if (!window.craft?.sharedKeychain) return showResult('keychain-result', 'sharedKeychain not available');
      try {
        const result = await window.craft.sharedKeychain.remove('test_key');
        showResult('keychain-result', 'Removed: ' + JSON.stringify(result));
      } catch (e) {
        showResult('keychain-result', 'Error: ' + e.message);
      }
    }

    // Auth Persistence tests
    async function testEnableAuthPersistence() {
      if (!window.craft?.authPersistence) return showResult('authpersist-result', 'authPersistence not available');
      try {
        const result = await window.craft.authPersistence.enable(300); // 5 minutes
        showResult('authpersist-result', 'Enabled: ' + JSON.stringify(result));
      } catch (e) {
        showResult('authpersist-result', 'Error: ' + e.message);
      }
    }

    async function testCheckAuthPersistence() {
      if (!window.craft?.authPersistence) return showResult('authpersist-result', 'authPersistence not available');
      try {
        const result = await window.craft.authPersistence.check();
        showResult('authpersist-result', 'Status: ' + JSON.stringify(result));
      } catch (e) {
        showResult('authpersist-result', 'Error: ' + e.message);
      }
    }

    async function testClearAuthPersistence() {
      if (!window.craft?.authPersistence) return showResult('authpersist-result', 'authPersistence not available');
      try {
        const result = await window.craft.authPersistence.clear();
        showResult('authpersist-result', 'Cleared: ' + JSON.stringify(result));
      } catch (e) {
        showResult('authpersist-result', 'Error: ' + e.message);
      }
    }

    // ==================== Nice to Have Bridges Tests ====================

    // AR tests
    async function testStartAR() {
      if (!window.craft?.ar) return showResult('ar-result', 'AR not available');
      try {
        const result = await window.craft.ar.start({planeDetection: true});
        showResult('ar-result', 'AR Started: ' + JSON.stringify(result));
      } catch (e) {
        showResult('ar-result', 'Error: ' + e.message);
      }
    }

    async function testPlaceARObject() {
      if (!window.craft?.ar) return showResult('ar-result', 'AR not available');
      try {
        const result = await window.craft.ar.placeObject('box', {x: 0, y: 0, z: -0.5});
        showResult('ar-result', 'Object placed: ' + JSON.stringify(result));
      } catch (e) {
        showResult('ar-result', 'Error: ' + e.message);
      }
    }

    async function testGetARPlanes() {
      if (!window.craft?.ar) return showResult('ar-result', 'AR not available');
      try {
        const planes = await window.craft.ar.getPlanes();
        showResult('ar-result', 'Detected planes: ' + JSON.stringify(planes, null, 2));
      } catch (e) {
        showResult('ar-result', 'Error: ' + e.message);
      }
    }

    async function testStopAR() {
      if (!window.craft?.ar) return showResult('ar-result', 'AR not available');
      try {
        const result = await window.craft.ar.stop();
        showResult('ar-result', 'AR Stopped: ' + JSON.stringify(result));
      } catch (e) {
        showResult('ar-result', 'Error: ' + e.message);
      }
    }

    // Listen for AR plane events
    window.addEventListener('craftARPlane', (e) => {
      log('AR Plane: ' + e.detail.type + ' - ' + e.detail.id);
      showResult('ar-result', 'Plane event: ' + JSON.stringify(e.detail));
    });

    // ML tests
    async function testCaptureAndClassify() {
      if (!window.craft) return showResult('ml-result', 'Craft not ready');
      try {
        showResult('ml-result', 'Capturing image...');
        const image = await window.craft.openCamera();
        if (!image) {
          showResult('ml-result', 'No image captured');
          return;
        }
        showResult('ml-result', 'Classifying...');
        const results = await window.craft.ml.classifyImage(image);
        showResult('ml-result', 'Classification results:\n' + JSON.stringify(results, null, 2));
      } catch (e) {
        showResult('ml-result', 'Error: ' + e.message);
      }
    }

    async function testCaptureAndDetect() {
      if (!window.craft) return showResult('ml-result', 'Craft not ready');
      try {
        showResult('ml-result', 'Capturing image...');
        const image = await window.craft.openCamera();
        if (!image) {
          showResult('ml-result', 'No image captured');
          return;
        }
        showResult('ml-result', 'Detecting objects...');
        const results = await window.craft.ml.detectObjects(image);
        showResult('ml-result', 'Detection results:\n' + JSON.stringify(results, null, 2));
      } catch (e) {
        showResult('ml-result', 'Error: ' + e.message);
      }
    }

    async function testCaptureAndOCR() {
      if (!window.craft) return showResult('ml-result', 'Craft not ready');
      try {
        showResult('ml-result', 'Capturing image...');
        const image = await window.craft.openCamera();
        if (!image) {
          showResult('ml-result', 'No image captured');
          return;
        }
        showResult('ml-result', 'Recognizing text...');
        const results = await window.craft.ml.recognizeText(image);
        showResult('ml-result', 'OCR results:\n' + JSON.stringify(results, null, 2));
      } catch (e) {
        showResult('ml-result', 'Error: ' + e.message);
      }
    }

    // Widget tests
    async function testUpdateWidget() {
      if (!window.craft?.widget) return showResult('widget-result', 'Widget API not available');
      try {
        const result = await window.craft.widget.update({
          title: 'Craft Widget',
          subtitle: 'Updated at ' + new Date().toLocaleTimeString(),
          value: Math.floor(Math.random() * 100).toString(),
          icon: 'star.fill'
        });
        showResult('widget-result', 'Widget updated: ' + JSON.stringify(result));
        log('Widget updated');
      } catch (e) {
        showResult('widget-result', 'Error: ' + e.message);
      }
    }

    async function testReloadWidgets() {
      if (!window.craft?.widget) return showResult('widget-result', 'Widget API not available');
      try {
        const result = await window.craft.widget.reload();
        showResult('widget-result', 'Widgets reloaded: ' + JSON.stringify(result));
        log('Widgets reloaded');
      } catch (e) {
        showResult('widget-result', 'Error: ' + e.message);
      }
    }

    // Siri / Voice Assistant tests
    async function testRegisterSiri() {
      if (!window.craft?.siri) return showResult('siri-result', 'Siri API not available');
      try {
        const result = await window.craft.siri.register('Open my app', 'open_app');
        showResult('siri-result', 'Siri shortcut registered: ' + JSON.stringify(result));
        log('Siri shortcut registered');
      } catch (e) {
        showResult('siri-result', 'Error: ' + e.message);
      }
    }

    async function testRemoveSiri() {
      if (!window.craft?.siri) return showResult('siri-result', 'Siri API not available');
      try {
        const result = await window.craft.siri.remove('open_app');
        showResult('siri-result', 'Siri shortcut removed: ' + JSON.stringify(result));
        log('Siri shortcut removed');
      } catch (e) {
        showResult('siri-result', 'Error: ' + e.message);
      }
    }

    // Listen for Siri invocations
    if (window.craft?.siri) {
      window.craft.siri.onInvoke((detail) => {
        log('Siri shortcut invoked: ' + JSON.stringify(detail));
        showResult('siri-result', 'Siri invoked: ' + JSON.stringify(detail));
      });
    }

    // Watch Connectivity tests
    async function testWatchReachable() {
      if (!window.craft?.watch) return showResult('watch-result', 'Watch API not available');
      try {
        const result = await window.craft.watch.isReachable();
        showResult('watch-result', 'Watch reachable: ' + JSON.stringify(result));
        log('Watch reachable: ' + JSON.stringify(result));
      } catch (e) {
        showResult('watch-result', 'Error: ' + e.message);
      }
    }

    async function testSendToWatch() {
      if (!window.craft?.watch) return showResult('watch-result', 'Watch API not available');
      try {
        const result = await window.craft.watch.send({
          action: 'ping',
          timestamp: Date.now()
        });
        showResult('watch-result', 'Sent to watch: ' + JSON.stringify(result));
        log('Sent message to watch');
      } catch (e) {
        showResult('watch-result', 'Error: ' + e.message);
      }
    }

    async function testUpdateWatchContext() {
      if (!window.craft?.watch) return showResult('watch-result', 'Watch API not available');
      try {
        const result = await window.craft.watch.updateContext({
          lastUpdate: Date.now(),
          status: 'active'
        });
        showResult('watch-result', 'Watch context updated: ' + JSON.stringify(result));
        log('Watch context updated');
      } catch (e) {
        showResult('watch-result', 'Error: ' + e.message);
      }
    }

    // Listen for Watch events
    if (window.craft?.watch) {
      window.craft.watch.onMessage((detail) => {
        log('Watch message received: ' + JSON.stringify(detail));
        showResult('watch-result', 'Watch message: ' + JSON.stringify(detail));
      });
      window.craft.watch.onReachabilityChange((detail) => {
        log('Watch reachability changed: ' + JSON.stringify(detail));
        showResult('watch-result', 'Reachability: ' + JSON.stringify(detail));
      });
    }

    // ==================== Deep Links ====================
    async function testGetInitialURL() {
      if (!window.craft?.deepLinks) return showResult('deeplink-result', 'Deep Links API not available');
      try {
        const result = await window.craft.deepLinks.getInitialURL();
        if (result) {
          showResult('deeplink-result', 'Initial URL: ' + JSON.stringify(result, null, 2));
          log('Initial URL: ' + result.url);
        } else {
          showResult('deeplink-result', 'App was not launched via deep link');
          log('No initial URL');
        }
      } catch (e) {
        showResult('deeplink-result', 'Error: ' + e.message);
      }
    }

    function setupDeepLinkListener() {
      if (!window.craft?.deepLinks) return showResult('deeplink-result', 'Deep Links API not available');
      window.craft.deepLinks.onLink((detail) => {
        log('Deep link received: ' + detail.url);
        showResult('deeplink-result', 'Deep Link: ' + JSON.stringify(detail, null, 2));
      });
      showResult('deeplink-result', 'Listener setup! Open a deep link to test.');
      log('Deep link listener setup');
    }

    // ==================== Performance Profiling ====================
    function testStartProfiling() {
      if (!window.craft) return showResult('profiling-result', 'Craft not ready');
      window.craft.startProfiling();
      showResult('profiling-result', 'Profiling started. Make some API calls, then stop profiling.');
      log('Profiling started');
    }

    function testStopProfiling() {
      if (!window.craft) return showResult('profiling-result', 'Craft not ready');
      const report = window.craft.stopProfiling();
      showResult('profiling-result', JSON.stringify(report, null, 2));
      log('Profiling stopped. Total calls: ' + report.totalCalls);
    }

    function testGetProfilingData() {
      if (!window.craft) return showResult('profiling-result', 'Craft not ready');
      const data = window.craft.getProfilingData();
      showResult('profiling-result', JSON.stringify(data, null, 2));
      log('Profiling data retrieved');
    }

    async function testGetMemoryUsage() {
      if (!window.craft) return showResult('profiling-result', 'Craft not ready');
      try {
        const memory = await window.craft.getMemoryUsage();
        showResult('profiling-result', 'Memory Usage:\n' + JSON.stringify(memory, null, 2));
        log('Memory: ' + memory.usedMB + ' MB used');
      } catch (e) {
        showResult('profiling-result', 'Error: ' + e.message);
      }
    }

    // ==================== OTA Updates ====================
    function testOTAConfigure() {
      if (!window.craft?.ota) return showResult('ota-result', 'OTA API not available');
      try {
        window.craft.ota.configure({
          updateUrl: 'https://updates.example.com/api/check',
          checkOnLaunch: true,
          checkInterval: 3600000 // 1 hour
        });
        showResult('ota-result', 'OTA configured successfully.\nURL: https://updates.example.com/api/check');
        log('OTA configured');
      } catch (e) {
        showResult('ota-result', 'Error: ' + e.message);
      }
    }

    async function testCheckForUpdate() {
      if (!window.craft?.ota) return showResult('ota-result', 'OTA API not available');
      try {
        showResult('ota-result', 'Checking for updates...');
        const update = await window.craft.ota.checkForUpdate();
        showResult('ota-result', 'Update check result:\n' + JSON.stringify(update, null, 2));
        log('Update available: ' + update.available);
      } catch (e) {
        showResult('ota-result', 'Error: ' + e.message);
      }
    }

    async function testDownloadUpdate() {
      if (!window.craft?.ota) return showResult('ota-result', 'OTA API not available');
      try {
        showResult('ota-result', 'Downloading update...');
        const result = await window.craft.ota.downloadUpdate();
        showResult('ota-result', 'Download result:\n' + JSON.stringify(result, null, 2));
        log('Download complete: ' + result.success);
      } catch (e) {
        showResult('ota-result', 'Error: ' + e.message);
      }
    }

    function testGetCurrentBundle() {
      if (!window.craft?.ota) return showResult('ota-result', 'OTA API not available');
      const bundle = window.craft.ota.getCurrentBundle();
      showResult('ota-result', 'Current bundle:\n' + JSON.stringify(bundle, null, 2));
      log('Current bundle version: ' + bundle.version);
    }

    // OTA event listeners
    if (window.craft?.ota) {
      window.craft.ota.onProgress((progress) => {
        log('OTA Download: ' + progress.percent + '%');
        showResult('ota-result', 'Downloading: ' + progress.percent + '% (' + progress.bytesDownloaded + '/' + progress.totalBytes + ')');
      });
      window.craft.ota.onStatusChange((status) => {
        log('OTA Status: ' + status);
        showResult('ota-result', 'Status: ' + status);
      });
    }

    log('Test page loaded, waiting for Craft...');
  </script>
</body>
</html>
